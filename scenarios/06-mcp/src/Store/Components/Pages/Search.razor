@page "/search"
@using Markdig
@using SearchEntities
@using global::Services

@inject ProductService ProductService
@inject Store.Services.McpServerService McpServerService
@inject IConfiguration Configuration
@attribute [StreamRendering(true)]
@rendermode InteractiveServer

<PageTitle>Search Products</PageTitle>

<h1>Search Products</h1>

<p>Search our amazing outdoor products that you can purchase.</p>

<div class="form-group">
    <label for="search" class="form-label">Type your question:</label>
    <div class="input-group mb-3">
        <input type="text" id="search" class="form-control" @bind="searchTerm" placeholder="Enter search term..." />
        <button id="btnSearch" class="btn btn-primary" @onclick="DoSearch" type="submit">Search</button>
    </div>    @if (tools != null && tools.Any())
    {
        <div class="card mb-3">
            <div class="card-header" @onclick="ToggleToolsInfo" style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Available MCP Server Tools</span>
                    <i class="@(showToolsInfo ? "oi oi-chevron-top" : "oi oi-chevron-bottom")"></i>
                </div>
            </div>
            <div class="collapse @(showToolsInfo ? "show" : "")" id="toolsDetails">
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Use</th>
                                <th>Name</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var tool in tools)
                            {
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   @onchange="e => ToggleToolSelection(tool, (bool)e.Value)" 
                                                   checked="@IsToolSelected(tool)" />
                                        </div>
                                    </td>
                                    <td>@tool.Name</td>
                                    <td>@tool.Description</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <hr />
</div>

@if (!string.IsNullOrEmpty(searchResponse.McpFunctionCallId))
{
    <div class="card mb-3">
        <div class="card-header" @onclick="ToggleFunctionInfo" style="cursor: pointer;">
            <div class="d-flex justify-content-between align-items-center">
                <span>Function Call Details</span>
                <i class="@(showFunctionInfo ? "oi oi-chevron-top" : "oi oi-chevron-bottom")"></i>
            </div>
        </div>
        <div class="collapse @(showFunctionInfo ? "show" : "")" id="functionCallDetails">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4"><strong>Function Call ID:</strong></div>
                    <div class="col-md-8">@searchResponse.McpFunctionCallId</div>
                </div>
                <div class="row">
                    <div class="col-md-4"><strong>Function Name:</strong></div>
                    <div class="col-md-8">@searchResponse.McpFunctionCallName</div>
                </div>
            </div>
        </div>
    </div>
}

@if (isLoading)
{
    <div class="loading">
        <p><em>Loading...</em></p>
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(searchResponse.Response))
{
    <div>
        <h2>Response</h2>
        @((MarkupString)RenderMarkdown(searchResponse.Response))
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}
@if (searchResponse.Products != null && searchResponse.Products.Count > 0)
{
    <div>
        <h2>Product List</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in searchResponse.Products)
                {
                    <tr>
                        <!-- Simulating images being hosted on a CDN -->
                        <td><img height="80" width="80" src="https://raw.githubusercontent.com/MicrosoftDocs/mslearn-dotnet-cloudnative/main/dotnet-docker/Products/wwwroot/images/@product.ImageUrl" /></td>
                        <td>@product.Name</td>
                        <td>@product.Description</td>
                        <td>@product.Price</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private SearchResponse searchResponse = new();
    private string searchTerm = "";
    private bool isLoading = false;
    private string errorMessage = "";
    private bool showFunctionInfo = false;
    private bool showToolsInfo = false;
    private IList<ModelContextProtocol.Client.McpClientTool> tools;
    private Dictionary<string, bool> selectedTools = new();
    private MarkdownPipeline markdownPipeline;
    
    // Computed property to determine if MCP search should be used based on selected tools
    private bool mcpSearch => selectedTools.Any(t => t.Value);    protected override void OnInitialized()
    {
        tools = McpServerService.GetTools();

        markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();
        
        // Initialize the selectedTools dictionary with all tools unselected
        foreach (var tool in tools)
        {
            selectedTools[tool.Name] = false;
        }
    }
    
    private void ToggleToolSelection(ModelContextProtocol.Client.McpClientTool tool, bool isSelected)
    {
        selectedTools[tool.Name] = isSelected;
        StateHasChanged();
    }
    
    private bool IsToolSelected(ModelContextProtocol.Client.McpClientTool tool)
    {
        if (selectedTools.TryGetValue(tool.Name, out bool value))
        {
            return value;
        }
        return false;
    }
    
    private IList<ModelContextProtocol.Client.McpClientTool> GetSelectedTools()
    {
        if (!mcpSearch)
            return new List<ModelContextProtocol.Client.McpClientTool>();
            
        return tools.Where(t => IsToolSelected(t)).ToList();
    }

    private string RenderMarkdown(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return string.Empty;

        return Markdig.Markdown.ToHtml(markdown, markdownPipeline);
    }    private async Task DoSearch(MouseEventArgs e)
    {
        try
        {
            isLoading = true;
            errorMessage = "";

            searchResponse = new();
            if (mcpSearch)
            {
                // Get only the selected tools
                var selectedToolsList = GetSelectedTools();
                
                // mcp search with selected tools
                searchResponse = await McpServerService.Search(searchTerm, selectedToolsList);
            }
            else
            {
                // keyword search
                searchResponse = await ProductService.Search(searchTerm);
            }

        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleFunctionInfo()
    {
        showFunctionInfo = !showFunctionInfo;
    }

    private void ToggleToolsInfo()
    {
        showToolsInfo = !showToolsInfo;
    }
}
